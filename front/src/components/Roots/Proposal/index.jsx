
import { useEffect } from "react";
import { useDispatch, useSelector } from "react-redux";
import { useNavigate } from 'react-router-dom';
import Proposition from "../../Layout/UXElements/components/Proposition";
import { v4 as uuidv4 } from 'uuid';
import { FaPlus } from "react-icons/fa";
import { FaMinus } from "react-icons/fa6";
import './Proposal.css';
import { NavLink } from "react-router-dom";
import types from "../../../store/reducers/types";
import { Form } from "react-router-dom";
import { HistoryApi } from "../../../api";


const Proposal = () => {
    const dispatch = useDispatch();
    const navigate = useNavigate()
    
    const {isConnected, id} = useSelector((state) => state.session);
    const {recipes} = useSelector((state) => state.proposal);
    const {numberOfProposition, generatedProposal, proposal, historicalPropositions} = useSelector((state) => state.proposal);

    const findProposal = historicalPropositions.find((e) => e.historic.id === proposal.id);
    const logoElement = document.querySelector("#imgLogo");
    const animationChef = "zoomInLeft"

    useEffect(() => {
        dispatch({type:types.SET_IS_ASIDE_TRUE});
    }, [])

    useEffect(() => {
        if (generatedProposal === false && generatedProposal !== null) {
            setProposition();
            dispatch({type:types.CLOSE_PROPOSAL})
        }

    }, [generatedProposal])

    const handleClickMinus = () => {
        if (numberOfProposition !== 0) dispatch({type:types.SUBTRACT_NUMBER_OF_PROPOSITION});
    }
    
    const handleClickPlus = () => {
        dispatch({type:types.ADD_NUMBER_OF_PROPOSITION});
    }

    const handleChange = () => {
        //
    }

    const handleSubmit = async (event) => {
        event.preventDefault();
        dispatch({type:types.GENERATE_PROPOSAL});
        new Promise((resolve, reject) => {
            logoElement.classList.add("animate__animated", `animate__${animationChef}`);
        
            // When the animation ends, we clean the classes and resolve the Promise
            function handleAnimationEnd(event) {
              event.stopPropagation();
              logoElement.classList.remove("animate__animated", `animate__${animationChef}`);
              resolve('Animation ended');
            }
        
            logoElement.addEventListener('animationend', handleAnimationEnd, {once: true});
          });
    }

    const setProposition = async () => {
        const proposalsWithValidate = recipes.map(recipe => {
            return { ...recipe, validate: true }; // Crée un nouvel objet avec la propriété validate ajoutée
        });

        const limitedProposal = proposalsWithValidate.slice(0, numberOfProposition)
        
        const objectProposal = {
            id: uuidv4(),
            array: limitedProposal
        }
        dispatch({ type: types.SET_PROPOSAL, payload: objectProposal });
    }

    const handleClickValidateChoices = async () => {

        if (proposal.array.length > 0) {
            if (!findProposal) {
                const createdHistory = await HistoryApi.create({userId:id});
                await Promise.all(proposal.array.map(async (recipe) => await HistoryApi.addRecipeToHistory(createdHistory.id, recipe.id, {validate:recipe.validate}) ));
                
                dispatch({type:types.SET_HISTORIC_PROPOSAL, payload:[... historicalPropositions, {date:new Date().toLocaleString(), historic:proposal}]});
                
            } else {
                navigate('/history')
            }
        }
    }
  

    return(
        <main className="outlet" style={{ gridColumn: '2 / -1' }}>
            <div id="imgLogoContainer">
                <svg id="imgLogo" version="1.0" xmlns="http://www.w3.org/2000/svg"  width="10rem" height="100%" viewBox="0 0 900.000000 900.000000"  preserveAspectRatio="xMidYMid meet">  
                    <g transform="translate(0.000000,900.000000) scale(0.100000,-0.100000)" fill="var(--colorLogo)" stroke="none"> 
                        <path d="M6550 7874 c-131 -19 -178 -29 -195 -41 -11 -7 -25 -13 -32 -13 -45 0 -247 -172 -273 -232 -5 -13 -14 -30 -19 -38 -92 -162 -68 -402 56 -569 26 -35 31 -47 22 -63 -6 -10 -17 -22 -24 -24 -8 -3 -39 -39 -70 -80 -30 -41 -72 -88 -91 -106 -82 -74 -100 -135 -67 -229 17 -46 17 -49 -2 -69 -23 -25 -99 -60 -131 -60 -12 0 -29 -7 -38 -15 -8 -8 -28 -15 -45 -15 -39 0 -40 -15 -6 -82 28 -55 33 -98 11 -98 -8 0 -16 7 -20 15 -4 11 -22 15 -70 15 -63 0 -119 -15 -178 -46 -105 -56 -246 53 -223 173 15 83 73 110 121 58 23 -25 44 -33 44 -16 0 5 -14 23 -31 40 -33 34 -85 42 -95 16 -4 -8 -12 -15 -18 -15 -7 0 -23 -15 -37 -32 -20 -28 -24 -44 -24 -108 0 -70 3 -78 36 -125 38 -54 132 -135 191 -166 21 -10 52 -19 71 -19 49 0 52 -9 13 -49 -35 -38 -66 -114 -66 -165 0 -16 8 -57 18 -90 21 -73 91 -150 167 -185 115 -53 181 -79 210 -83 17 -3 20 -12 23 -59 4 -79 -8 -89 -108 -89 -52 0 -82 -4 -87 -12 -4 -7 -10 -47 -13 -88 l-5 -75 -55 -6 c-74 -7 -175 -27 -231 -45 -26 -8 -54 -14 -63 -14 -18 0 -199 -81 -246 -110 -8 -5 -51 -31 -95 -57 -190 -112 -415 -319 -528 -486 -92 -136 -193 -324 -221 -409 -3 -10 -14 -18 -24 -18 -19 0 -109 88 -202 200 -30 35 -61 71 -69 79 -19 20 -132 195 -169 261 -48 86 -102 200 -147 310 -10 25 -22 49 -25 53 -11 13 -55 -9 -99 -52 -24 -23 -49 -40 -55 -38 -6 2 -14 19 -18 38 -8 42 -26 114 -39 153 -10 33 1 51 83 141 47 52 94 127 127 204 39 91 79 147 156 216 41 37 75 71 75 76 0 15 -49 10 -93 -11 -80 -37 -127 -92 -207 -245 -29 -55 -90 -151 -137 -214 l-84 -115 3 -163 3 -163 -35 -33 c-65 -60 -120 -99 -136 -95 -16 3 -42 41 -89 133 -14 28 -37 68 -50 90 -13 22 -24 48 -25 58 0 10 -21 59 -47 110 -25 51 -52 106 -58 122 -46 115 -115 250 -148 291 -66 79 -239 192 -351 228 -100 32 -136 12 -54 -29 264 -133 356 -212 431 -370 30 -63 221 -455 246 -505 13 -25 38 -72 56 -105 18 -33 34 -67 34 -76 1 -14 -57 -69 -73 -69 -3 0 -12 13 -21 30 -9 16 -20 30 -25 30 -5 0 -32 -17 -59 -37 -59 -44 -62 -59 -25 -129 50 -94 76 -139 95 -169 10 -16 23 -39 29 -50 49 -92 255 -379 364 -506 17 -19 50 -58 74 -86 66 -80 143 -155 150 -148 4 3 2 9 -3 13 -11 8 -31 38 -42 62 -3 8 -25 40 -48 70 -46 61 -97 137 -108 160 -4 8 -16 29 -27 45 -10 17 -25 41 -33 55 -7 14 -33 61 -57 105 -125 227 -240 456 -240 475 0 8 30 35 66 60 35 25 70 50 77 55 16 13 54 40 142 99 38 27 74 54 80 61 12 16 85 65 96 65 4 0 11 -10 14 -22 6 -23 16 -44 55 -128 111 -235 327 -511 509 -649 133 -101 155 -108 177 -60 39 86 77 166 84 179 5 8 21 38 36 65 40 76 113 183 173 255 105 127 395 400 425 400 3 0 26 14 52 32 52 35 313 169 363 186 31 11 32 10 25 -11 -7 -23 -141 -205 -181 -246 -13 -13 -33 -40 -45 -60 -12 -20 -67 -97 -123 -171 -125 -169 -206 -285 -222 -320 -3 -8 -18 -31 -32 -50 -15 -19 -36 -53 -48 -75 -11 -22 -30 -56 -42 -75 -11 -19 -32 -57 -46 -85 -14 -27 -35 -63 -45 -80 -11 -16 -23 -37 -26 -45 -4 -8 -30 -64 -59 -125 -60 -125 -85 -181 -109 -245 -10 -25 -23 -58 -30 -75 -7 -16 -18 -46 -25 -65 -31 -92 -83 -251 -97 -300 -9 -30 -23 -70 -30 -88 -8 -18 -14 -41 -14 -51 0 -9 -6 -37 -14 -62 -20 -67 -38 -139 -46 -189 -4 -25 -12 -65 -18 -90 -29 -123 -72 -364 -72 -406 0 -16 -6 -72 -14 -124 -36 -225 -49 -441 -43 -686 6 -275 22 -477 43 -550 8 -28 14 -73 14 -100 0 -56 14 -90 26 -61 8 21 0 188 -16 342 -26 238 4 676 66 970 8 39 14 86 14 106 0 20 7 58 15 85 8 27 15 61 15 77 0 15 6 53 14 85 8 31 22 93 31 137 18 86 38 167 62 255 8 30 22 80 30 110 9 30 21 71 28 90 7 19 36 105 64 190 63 195 76 231 107 295 13 29 24 55 24 58 0 4 14 37 31 74 16 38 36 82 44 98 43 96 116 237 183 355 17 30 38 69 45 85 8 17 44 74 81 129 36 54 66 101 66 103 0 3 30 53 66 112 36 58 71 115 77 125 7 11 44 64 82 117 39 54 95 132 125 174 30 42 62 84 70 93 9 9 28 34 42 55 14 21 35 45 46 53 23 16 24 15 137 -36 113 -51 186 -75 278 -89 72 -11 75 -20 33 -88 -21 -32 -43 -67 -49 -78 -7 -11 -24 -36 -39 -56 -16 -20 -28 -40 -28 -44 0 -4 -13 -24 -30 -45 -16 -21 -30 -40 -30 -43 0 -3 -19 -34 -42 -69 -24 -35 -48 -73 -55 -84 -7 -10 -38 -61 -70 -112 -122 -196 -220 -389 -312 -614 -100 -249 -116 -290 -137 -358 -16 -53 -28 -88 -54 -160 -6 -19 -16 -51 -20 -70 -5 -19 -20 -75 -33 -125 -27 -105 -44 -180 -56 -250 -5 -27 -13 -68 -19 -90 -27 -104 -75 -395 -113 -695 -22 -169 -24 -818 -3 -797 3 3 9 101 14 218 5 118 14 248 19 289 10 70 21 165 41 355 8 79 19 145 45 280 28 146 47 232 61 281 8 28 14 59 14 69 0 10 7 43 16 74 8 31 22 81 31 111 8 30 21 71 28 90 27 76 37 106 47 140 5 19 14 39 19 45 5 5 9 18 9 28 0 10 6 31 14 45 8 15 22 47 31 72 10 25 23 59 30 75 7 17 21 50 30 75 10 25 23 59 31 75 7 17 29 69 49 117 19 49 50 114 67 145 49 89 94 173 123 228 27 53 33 64 78 133 15 24 27 45 27 49 0 3 14 25 30 50 17 24 30 46 30 48 0 3 24 39 53 80 28 42 57 84 62 94 6 9 36 53 68 96 31 44 96 134 144 200 47 66 97 135 110 153 l24 32 187 0 c189 0 429 19 579 45 45 8 111 15 148 15 59 0 69 -3 92 -27 14 -16 29 -37 34 -48 10 -21 21 -39 83 -132 77 -114 92 -138 99 -155 10 -26 27 -22 27 7 0 25 -7 44 -71 180 -20 44 -47 105 -59 135 -12 30 -31 73 -43 95 -11 22 -24 47 -28 55 -4 8 -21 43 -38 78 -17 34 -31 75 -31 90 0 27 21 99 46 160 32 76 4 122 -86 136 -60 9 -120 27 -120 36 0 4 20 13 44 19 34 8 56 24 95 68 48 54 63 83 41 83 -5 0 -13 -6 -17 -13 -14 -23 -87 -73 -133 -91 -25 -10 -65 -28 -90 -41 -40 -21 -45 -28 -48 -61 -2 -22 4 -51 14 -70 22 -41 18 -46 -66 -69 -94 -25 -683 -24 -810 2 -78 17 -85 20 -88 43 -2 14 3 44 10 65 11 34 17 40 38 37 14 -2 86 -6 161 -9 124 -4 141 -3 185 16 27 12 44 25 38 30 -5 4 -49 14 -99 21 -193 28 -293 46 -345 65 -89 31 -107 37 -135 44 -59 15 -148 66 -195 112 -70 69 -97 165 -68 245 13 38 40 52 119 63 30 5 62 11 71 15 12 6 21 0 32 -21 37 -69 170 -178 261 -214 22 -9 56 -22 75 -30 49 -19 263 -19 310 1 119 49 220 143 220 204 0 33 -17 42 -25 14 -34 -110 -261 -184 -390 -127 -49 22 -130 95 -201 183 -90 111 -111 125 -191 129 -72 4 -79 8 -87 48 -5 26 -1 34 24 56 36 30 40 72 10 110 -31 40 -26 53 23 53 23 1 65 9 92 18 114 41 132 62 115 137 -15 65 -13 71 51 142 34 37 65 77 71 88 12 28 30 56 53 88 30 41 122 60 218 47 118 -17 184 -44 312 -126 132 -85 215 -160 314 -284 70 -87 168 -225 184 -260 4 -8 17 -31 28 -50 43 -71 84 -156 89 -185 3 -18 12 -31 26 -35 11 -3 38 -22 61 -43 80 -74 168 -120 295 -151 83 -20 122 -20 206 0 109 26 185 62 272 128 83 64 134 125 169 201 21 47 51 176 51 221 0 70 -40 204 -84 281 -34 61 -132 149 -208 188 -21 11 -38 23 -38 28 0 5 12 24 27 44 46 60 56 100 61 228 4 148 -11 211 -85 348 -33 61 -148 160 -238 204 -121 60 -156 68 -330 68 -166 0 -166 0 -280 -50 -16 -7 -37 -15 -46 -18 -19 -6 -39 10 -39 31 0 38 -128 164 -201 198 -93 44 -251 77 -319 68z m207 -189 c78 -34 108 -51 140 -78 41 -36 103 -130 103 -156 0 -25 24 -27 72 -7 83 35 142 46 262 46 123 0 245 -18 299 -46 16 -8 34 -14 40 -14 7 0 23 -10 37 -23 14 -12 46 -40 72 -61 51 -41 131 -144 167 -215 25 -50 39 -205 27 -304 -7 -56 -8 -57 -39 -57 -18 1 -43 7 -57 15 -29 17 -140 20 -140 5 0 -6 8 -13 18 -16 47 -15 100 -41 130 -63 38 -28 159 -165 173 -196 5 -11 18 -33 29 -50 11 -16 22 -37 26 -45 3 -8 12 -31 21 -51 24 -59 14 -230 -17 -294 -28 -57 -100 -132 -151 -157 -99 -48 -113 -51 -219 -52 -139 0 -233 32 -314 107 -30 28 -31 32 -12 70 8 15 12 27 9 27 -9 0 -76 -51 -90 -67 -15 -19 -24 -13 -44 29 -43 88 -89 178 -108 209 -12 19 -24 40 -28 48 -30 64 -178 246 -269 331 -58 55 -205 170 -234 183 -8 4 -28 16 -45 26 -30 20 -92 51 -150 76 -37 16 -156 45 -184 45 -12 0 -21 5 -21 12 0 20 73 76 107 83 18 3 33 10 33 15 0 5 25 26 56 46 69 46 60 63 -22 39 -33 -10 -74 -23 -92 -31 -18 -8 -39 -14 -47 -14 -8 0 -30 -8 -50 -17 -33 -16 -37 -16 -52 0 -31 30 -82 205 -83 280 0 65 46 157 113 225 28 28 56 52 62 52 6 0 16 5 23 12 16 16 77 38 132 48 71 14 274 4 317 -15z m306 -2545 c-2 -19 -8 -61 -14 -93 -7 -34 -10 -96 -6 -152 6 -105 6 -105 -66 -105 -23 0 -96 -7 -162 -15 -185 -22 -665 -20 -820 4 -66 10 -142 25 -169 32 l-48 14 5 50 c5 51 26 189 33 213 4 14 50 13 359 -9 196 -14 496 -11 600 6 101 16 153 33 217 69 57 33 74 30 71 -14z"/> 
                        <path d="M6417 7034 c-11 -12 3 -24 27 -24 13 0 29 -7 36 -15 7 -8 18 -15 25 -15 44 0 277 -122 380 -199 126 -95 277 -252 308 -321 4 -8 16 -28 26 -45 30 -46 141 -276 155 -318 7 -21 26 -13 26 11 0 34 -91 241 -143 327 -114 186 -256 329 -447 451 -83 52 -243 124 -279 124 -9 0 -29 7 -45 15 -30 16 -58 19 -69 9z"/> 
                        <path d="M2794 7295 c-20 -35 -32 -45 -52 -45 -45 -1 -131 -36 -168 -68 -65 -58 -54 -126 25 -152 35 -11 48 -11 84 0 23 8 45 18 48 23 9 13 86 30 134 29 45 0 132 -16 142 -25 14 -15 -34 -19 -89 -8 -46 9 -71 9 -119 -1 l-60 -12 6 -32 c6 -36 7 -35 -130 -50 -57 -5 -135 -23 -200 -46 -16 -5 -46 -14 -65 -18 -19 -4 -60 -18 -90 -30 -30 -12 -64 -24 -75 -27 -21 -5 -37 -12 -145 -61 -145 -66 -165 -77 -265 -144 -68 -46 -149 -113 -210 -173 -90 -92 -182 -196 -210 -240 -40 -62 -105 -200 -105 -223 -1 -9 -7 -28 -15 -42 -21 -36 -19 -87 3 -94 9 -2 141 -2 292 0 151 2 673 8 1160 13 510 5 915 13 955 19 39 5 133 15 210 22 77 6 149 14 159 17 19 5 19 6 0 17 -14 8 -300 12 -1024 14 -553 2 -1009 7 -1014 12 -4 4 -1 21 7 37 9 15 32 61 52 102 92 190 259 363 476 495 42 25 81 46 87 46 5 0 12 7 16 15 14 36 -105 4 -252 -69 -67 -33 -84 -43 -111 -68 -15 -13 -55 -46 -91 -73 -119 -90 -262 -253 -324 -370 -15 -27 -31 -57 -36 -65 -5 -8 -11 -23 -14 -32 -3 -10 -10 -18 -16 -18 -14 0 -12 37 4 68 8 15 29 58 47 95 19 38 40 73 46 79 7 6 13 15 13 20 0 34 201 243 290 303 81 54 140 99 140 107 0 17 -32 6 -127 -42 -123 -64 -114 -58 -258 -165 -181 -135 -272 -236 -356 -395 -41 -76 -57 -96 -71 -82 -9 9 -7 20 8 49 80 156 220 351 311 432 50 45 158 124 251 183 95 61 251 126 387 161 172 45 195 48 424 49 247 1 377 -16 561 -74 19 -6 51 -15 70 -19 64 -13 125 -38 265 -105 132 -63 178 -92 310 -190 105 -79 363 -329 378 -366 3 -10 11 -18 17 -18 16 0 12 40 -5 46 -8 4 -15 10 -15 16 0 14 -142 197 -201 259 -30 30 -85 82 -124 115 -181 155 -295 225 -517 318 -18 8 -50 21 -71 30 -21 9 -44 16 -52 16 -8 0 -29 6 -47 14 -182 77 -360 112 -448 87 -27 -8 -60 -3 -60 9 0 4 15 11 33 16 18 6 36 19 42 32 7 17 15 21 30 17 64 -19 91 -17 123 10 43 36 42 72 0 121 -35 40 -101 74 -163 83 -34 5 -43 12 -63 49 -23 40 -25 42 -72 42 -48 0 -50 -1 -76 -45z"/> 
                        <path d="M835 5803 c-11 -1 -51 -5 -88 -8 -77 -8 -95 -25 -56 -53 29 -22 108 -69 134 -81 106 -48 141 -61 164 -61 14 0 42 -5 61 -11 27 -8 949 -26 1085 -20 11 0 78 3 148 7 85 4 132 3 139 -4 7 -7 16 -7 27 0 11 7 218 7 651 1 349 -5 648 -5 665 -1 16 5 168 8 337 8 513 0 636 18 851 126 16 8 34 14 40 14 7 1 26 12 42 26 28 23 29 26 12 38 -10 8 -53 17 -95 20 -67 5 -4064 4 -4117 -1z"/> 
                        <path d="M2452 5529 c2 -7 31 -20 63 -31 33 -10 87 -32 120 -48 33 -17 65 -30 72 -30 6 0 47 -26 90 -58 43 -32 85 -61 93 -65 20 -10 46 -27 95 -59 62 -41 87 -44 121 -13 16 14 73 67 128 118 104 96 198 167 221 167 21 0 29 19 10 26 -20 8 -123 -37 -193 -83 -30 -19 -81 -60 -114 -91 -88 -82 -91 -84 -125 -69 -15 7 -75 44 -133 82 -112 74 -167 105 -187 105 -7 0 -27 6 -45 14 -102 43 -225 63 -216 35z"/> 
                        <path d="M5444 4643 c-38 -7 -59 -40 -59 -95 0 -43 4 -53 29 -75 39 -33 89 -27 129 17 68 75 6 171 -99 153z"/> 
                        <path d="M5035 3979 c-30 -27 -35 -37 -35 -75 0 -52 28 -97 72 -115 24 -10 35 -9 67 5 46 21 71 61 71 114 0 33 -6 45 -35 71 -25 22 -46 31 -70 31 -24 0 -45 -9 -70 -31z"/> 
                        <path d="M4677 3275 c-47 -24 -66 -55 -67 -105 0 -63 45 -120 96 -120 48 0 80 24 100 76 16 41 16 47 0 87 -10 26 -28 49 -45 60 -35 21 -48 21 -84 2z"/> 
                        <path d="M4395 2393 c-37 -8 -60 -53 -60 -116 0 -53 3 -61 29 -84 25 -21 37 -24 73 -20 60 6 93 50 93 122 0 80 -50 116 -135 98z"/> 
                        <path d="M4249 1578 c-24 -27 -29 -41 -29 -83 1 -63 25 -95 77 -101 50 -6 84 13 106 59 22 45 16 85 -20 127 -36 43 -93 42 -134 -2z"/> 
                        <path d="M4023 360 c0 -25 2 -35 4 -22 2 12 2 32 0 45 -2 12 -4 2 -4 -23z"/> 
                    </g> 
                </svg> 
            </div>

            <section className="section">
                
                    <Form className="section__start" action="/proposal">
                        <div>
                            <FaMinus onClick={handleClickMinus} id="minus" style={{color:"var(--colorUi4)"}} size={20}/>
                            <input type="number" value={numberOfProposition} onChange={handleChange} id="starter" aria-label="Nombre de propositions."/>
                            <FaPlus onClick={handleClickPlus} id="plus" style={{color:"var(--colorUi4)"}} size={20}/>
                        </div>
  
                        <button onClick={handleSubmit} className="buttonStarter" id="starterButton">C'est parti !</button>
                    </Form>
            </section>

            <section className="section">
                    {proposal.array.length > 0?
                    <>
                        <ul className="section__ulContainerProposal">
                            {proposal.array.map((element, index) => {
                                return(
                                    <Proposition proposition={element} key={index}/>
                                )
                            })}
                        </ul>
                        {isConnected?
                            <div className="section__btnValidate">
                                <button className="btnValidate" role="button" onClick={handleClickValidateChoices}>{findProposal?"Voir l'historique":"Valider les choix"}</button>
                            </div>
                            :
                            <div className="section__btnValidate">
                                <p>Connecte toi <NavLink to={"/signin"}>ici</NavLink> pour valider tes choix</p>
                            </div>
                            }
                    
                    </>
                        :
                        <p className="section__pNoResults">Aucuns résultats. Précise tes critères</p>
                    }
            </section>
        </main>
    )
}

export default Proposal;

